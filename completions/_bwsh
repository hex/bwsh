#compdef bwsh bwgetkey bwkey bwkeys bwdelkey bwrun bwenv
# ABOUTME: Zsh completion script for bwsh (Bitwarden Secrets Manager wrapper)
# ABOUTME: Provides tab-completion for commands and secret names

# Helper: get secret names
_bwsh_secrets() {
    local -a secrets
    if command -v bwsh >/dev/null 2>&1; then
        secrets=(${(f)"$(bwsh list 2>/dev/null)"})
    fi
    compadd -a secrets
}

# Main bwsh completion
_bwsh() {
    local curcontext="$curcontext" state line
    typeset -A opt_args

    # Commands with descriptions
    local -a commands
    commands=(
        'get:Get a secret value'
        'set:Create or update a secret'
        'list:List all secret names'
        'delete:Delete a secret'
        'run:Run command with secrets as env vars'
        'env:Export/import .env files'
        'setup:Interactive configuration'
        'update:Update to latest version'
        'version:Show version'
        'help:Show help'
    )

    # First argument: command
    if [[ $CURRENT -eq 2 ]]; then
        _describe 'command' commands
        return
    fi

    # Subsequent arguments depend on command
    local cmd="${words[2]}"
    case "$cmd" in
        get|delete)
            _bwsh_secrets
            ;;
        set)
            if [[ $CURRENT -eq 3 ]]; then
                _bwsh_secrets
            fi
            # Value argument: no completion
            ;;
        run)
            # Check for --project/-p flag
            if [[ "${words[CURRENT-1]}" == "--project" || "${words[CURRENT-1]}" == "-p" ]]; then
                return 0  # No completion for project ID
            fi
            # Offer --project flag or executables
            if [[ "${words[CURRENT]}" == -* ]]; then
                _arguments '--project[Use specific project]:project id:' '-p[Use specific project]:project id:'
            else
                _command_names -e
            fi
            ;;
        env)
            if [[ $CURRENT -eq 3 ]]; then
                local -a env_commands
                env_commands=(
                    'export:Export secrets as .env format'
                    'import:Import secrets from .env file'
                )
                _describe 'env command' env_commands
            elif [[ "${words[3]}" == "import" ]]; then
                # Check for --project/-p flag
                if [[ "${words[CURRENT-1]}" == "--project" || "${words[CURRENT-1]}" == "-p" ]]; then
                    return 0  # No completion for project ID
                fi
                # Offer file completion or flags
                if [[ "${words[CURRENT]}" == -* ]]; then
                    _arguments '--project[Use specific project]:project id:' '-p[Use specific project]:project id:' '--dry-run[Preview without importing]'
                else
                    _files
                fi
            fi
            ;;
        update)
            _arguments '--check[Check for updates without installing]' '-c[Check for updates without installing]'
            ;;
    esac

    return 1
}

# bwgetkey completion
_bwgetkey() {
    _bwsh_secrets
}

# bwkey completion (first arg only)
_bwkey() {
    if [[ $CURRENT -eq 2 ]]; then
        _bwsh_secrets
    fi
}

# bwdelkey completion
_bwdelkey() {
    _bwsh_secrets
}

# bwkeys - no arguments
_bwkeys() {
    return 1
}

# bwrun - command completion with --project flag
_bwrun() {
    # Check for --project/-p flag
    if [[ "${words[CURRENT-1]}" == "--project" || "${words[CURRENT-1]}" == "-p" ]]; then
        return 0  # No completion for project ID
    fi
    # Offer --project flag or executables
    if [[ "${words[CURRENT]}" == -* ]]; then
        _arguments '--project[Use specific project]:project id:' '-p[Use specific project]:project id:'
    else
        _command_names -e
    fi
}

# bwenv - subcommand completion with --project flag for import
_bwenv() {
    if [[ $CURRENT -eq 2 ]]; then
        local -a env_commands
        env_commands=(
            'export:Export secrets as .env format'
            'import:Import secrets from .env file'
        )
        _describe 'env command' env_commands
    elif [[ "${words[2]}" == "import" ]]; then
        # Check for --project/-p flag
        if [[ "${words[CURRENT-1]}" == "--project" || "${words[CURRENT-1]}" == "-p" ]]; then
            return 0  # No completion for project ID
        fi
        # Offer file completion or flags
        if [[ "${words[CURRENT]}" == -* ]]; then
            _arguments '--project[Use specific project]:project id:' '-p[Use specific project]:project id:' '--dry-run[Preview without importing]'
        else
            _files
        fi
    fi
}

# Service dispatch
case "$service" in
    bwsh)
        _bwsh "$@"
        ;;
    bwgetkey)
        _bwgetkey "$@"
        ;;
    bwkey)
        _bwkey "$@"
        ;;
    bwkeys)
        _bwkeys "$@"
        ;;
    bwdelkey)
        _bwdelkey "$@"
        ;;
    bwrun)
        _bwrun "$@"
        ;;
    bwenv)
        _bwenv "$@"
        ;;
esac
