#compdef bwsh bwgetkey bwkey bwkeys bwdelkey bwrun bwenv
# ABOUTME: Zsh completion script for bwsh (Bitwarden Secrets Manager wrapper)
# ABOUTME: Provides tab-completion for commands and secret names

# Helper: get secret names
_bwsh_secrets() {
    local -a secrets
    if command -v bwsh >/dev/null 2>&1; then
        secrets=(${(f)"$(bwsh list 2>/dev/null)"})
    fi
    compadd -a secrets
}

# Main bwsh completion
_bwsh() {
    local curcontext="$curcontext" state line
    typeset -A opt_args

    # Commands with descriptions
    local -a commands
    commands=(
        'get:Get a secret value'
        'set:Create or update a secret'
        'list:List all secret names'
        'delete:Delete a secret'
        'run:Run command with secrets as env vars'
        'env:Export/import .env files'
        'setup:Interactive configuration'
        'version:Show version'
        'help:Show help'
    )

    # First argument: command
    if [[ $CURRENT -eq 2 ]]; then
        _describe 'command' commands
        return
    fi

    # Subsequent arguments depend on command
    local cmd="${words[2]}"
    case "$cmd" in
        get|delete)
            _bwsh_secrets
            ;;
        set)
            if [[ $CURRENT -eq 3 ]]; then
                _bwsh_secrets
            fi
            # Value argument: no completion
            ;;
        run)
            # Complete with executables
            _command_names -e
            ;;
        env)
            if [[ $CURRENT -eq 3 ]]; then
                local -a env_commands
                env_commands=(
                    'export:Export secrets as .env format'
                    'import:Import secrets from .env file'
                )
                _describe 'env command' env_commands
            elif [[ $CURRENT -eq 4 && "${words[3]}" == "import" ]]; then
                _files
            fi
            ;;
    esac

    return 1
}

# bwgetkey completion
_bwgetkey() {
    _bwsh_secrets
}

# bwkey completion (first arg only)
_bwkey() {
    if [[ $CURRENT -eq 2 ]]; then
        _bwsh_secrets
    fi
}

# bwdelkey completion
_bwdelkey() {
    _bwsh_secrets
}

# bwkeys - no arguments
_bwkeys() {
    return 1
}

# bwrun - command completion
_bwrun() {
    _command_names -e
}

# bwenv - subcommand completion
_bwenv() {
    if [[ $CURRENT -eq 2 ]]; then
        local -a env_commands
        env_commands=(
            'export:Export secrets as .env format'
            'import:Import secrets from .env file'
        )
        _describe 'env command' env_commands
    elif [[ $CURRENT -eq 3 && "${words[2]}" == "import" ]]; then
        _files
    fi
}

# Service dispatch
case "$service" in
    bwsh)
        _bwsh "$@"
        ;;
    bwgetkey)
        _bwgetkey "$@"
        ;;
    bwkey)
        _bwkey "$@"
        ;;
    bwkeys)
        _bwkeys "$@"
        ;;
    bwdelkey)
        _bwdelkey "$@"
        ;;
    bwrun)
        _bwrun "$@"
        ;;
    bwenv)
        _bwenv "$@"
        ;;
esac
